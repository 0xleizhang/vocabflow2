<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explore - Philingo English Reader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:ital,wght@0,300;0,400;1,400&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .text-card {
            transition: all 0.2s ease;
        }

        .text-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.1);
        }

        .difficulty-beginner { background: #dcfce7; color: #166534; }
        .difficulty-intermediate { background: #fef3c7; color: #92400e; }
        .difficulty-advanced { background: #fee2e2; color: #991b1b; }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Expandable full text */
        .full-text-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .full-text-content.expanded {
            max-height: 500px;
            overflow-y: auto;
        }

        .expand-btn {
            transition: transform 0.2s ease;
        }

        .expand-btn.expanded {
            transform: rotate(180deg);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                        }
                    }
                },
            },
        }
    </script>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
    <div class="max-w-6xl mx-auto px-4 py-12">
        <!-- Header -->
        <div class="mb-10 animate-fade-in">
            <a href="/" class="inline-flex items-center text-slate-600 hover:text-slate-900 mb-6 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                Back to App
            </a>

            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-sky-500 to-cyan-600 rounded-xl flex items-center justify-center relative">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                        <span class="absolute -bottom-1 -right-1 bg-white text-sky-600 text-[10px] font-bold px-1 rounded shadow-sm">Ph</span>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-slate-900">Explore Texts</h1>
                        <p class="text-slate-600 mt-1">Choose a text to start practicing your English reading and pronunciation</p>
                    </div>
                </div>
                <button onclick="openGenerateModal()" class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-medium rounded-lg hover:from-violet-600 hover:to-purple-700 transition-all shadow-md hover:shadow-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    Generate Text
                </button>
            </div>
        </div>

        <!-- Generate Text Modal -->
        <div id="generateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeGenerateModal(event)">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 animate-fade-in" onclick="event.stopPropagation()">
                <div class="p-6 border-b border-slate-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-violet-500 to-purple-600 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold text-slate-900">Generate Practice Text</h2>
                        </div>
                        <button onclick="closeGenerateModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Describe what kind of text you want to practice with:</label>
                        <textarea 
                            id="generatePrompt" 
                            placeholder="Example: A short story about a cat learning to code, using beginner-level vocabulary"
                            class="w-full h-32 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-transparent resize-none text-slate-700"
                        ></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Text length:</label>
                        <select id="textLength" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-transparent">
                            <option value="short">Short (50-100 words)</option>
                            <option value="medium" selected>Medium (100-200 words)</option>
                            <option value="long">Long (200-300 words)</option>
                        </select>
                    </div>
                    <div id="generateError" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm"></div>
                    <div id="generateSuccess" class="hidden mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm"></div>
                    <div class="flex gap-3">
                        <button onclick="closeGenerateModal()" class="flex-1 px-4 py-2 border border-slate-300 text-slate-700 font-medium rounded-lg hover:bg-slate-50 transition-colors">
                            Cancel
                        </button>
                        <button onclick="generateText()" id="generateBtn" class="flex-1 px-4 py-2 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-medium rounded-lg hover:from-violet-600 hover:to-purple-700 transition-all flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            Generate
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div id="historySection" class="mb-8 hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-slate-900 flex items-center gap-2">
                    <svg class="w-6 h-6 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Your History
                </h2>
                <button onclick="clearHistory()" class="text-sm text-slate-500 hover:text-red-600 transition-colors flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Clear History
                </button>
            </div>
            <div class="grid md:grid-cols-2 gap-4" id="historyCards">
                <!-- History cards will be inserted here -->
            </div>
        </div>

        <!-- Text Cards Grid -->
        <h2 class="text-2xl font-bold text-slate-900 mb-4">Sample Texts</h2>
        <div class="grid md:grid-cols-2 gap-6" id="textCards">
            <!-- Cards will be inserted here by JavaScript -->
        </div>
    </div>

    <script>
        const STORAGE_KEY_HISTORY = 'philingo_text_history';
        const STORAGE_KEY_API = 'gemini_api_key';
        
        // Text snippets for practice
        const textSnippets = [
            {
                id: 1,
                title: "The Power of Habit",
                category: "Self-Improvement",
                difficulty: "beginner",
                wordCount: 85,
                text: `Habits are the invisible architecture of daily life. We repeat about 40 percent of our behavior almost daily. When we understand how habits work, we can change them. The key is to identify the cue, the routine, and the reward. Once you recognize these patterns, you can start to shift your behaviors. Small changes in daily habits can lead to remarkable results over time.`,
                preview: "Habits are the invisible architecture of daily life..."
            },
            {
                id: 2,
                title: "Climate Change Explained",
                category: "Science",
                difficulty: "intermediate",
                wordCount: 95,
                text: `Climate change refers to long-term shifts in global temperatures and weather patterns. While natural factors have always influenced Earth's climate, human activities have been the primary driver since the industrial revolution. The burning of fossil fuels releases greenhouse gases, which trap heat in the atmosphere. Scientists warn that without significant action to reduce emissions, we may face more extreme weather events, rising sea levels, and disruptions to ecosystems worldwide.`,
                preview: "Climate change refers to long-term shifts in global temperatures..."
            },
            {
                id: 3,
                title: "The Art of Communication",
                category: "Business",
                difficulty: "intermediate",
                wordCount: 88,
                text: `Effective communication is the cornerstone of successful relationships, both personal and professional. It involves not just speaking clearly, but also listening actively. When we truly listen, we show respect and build trust. Good communicators also pay attention to nonverbal cues like body language and tone of voice. In today's digital age, written communication skills are equally important. The ability to express ideas concisely and persuasively can open many doors.`,
                preview: "Effective communication is the cornerstone of successful relationships..."
            },
            {
                id: 4,
                title: "Artificial Intelligence",
                category: "Technology",
                difficulty: "advanced",
                wordCount: 102,
                text: `Artificial intelligence represents one of the most transformative technologies of our time. Machine learning algorithms can now recognize patterns in vast datasets, enabling applications from medical diagnosis to autonomous vehicles. However, this rapid advancement raises important ethical questions. How do we ensure AI systems are fair and unbiased? Who is responsible when an algorithm makes a harmful decision? As these technologies become more integrated into society, we must carefully consider their implications for privacy, employment, and human autonomy.`,
                preview: "Artificial intelligence represents one of the most transformative technologies..."
            },
            {
                id: 5,
                title: "Mindfulness Meditation",
                category: "Wellness",
                difficulty: "beginner",
                wordCount: 78,
                text: `Mindfulness is the practice of being fully present in the moment. It means paying attention to your thoughts and feelings without judgment. Regular meditation can reduce stress and improve focus. To begin, find a quiet place and sit comfortably. Close your eyes and focus on your breath. When your mind wanders, gently bring it back. Even five minutes a day can make a difference in your mental well-being.`,
                preview: "Mindfulness is the practice of being fully present in the moment..."
            },
            {
                id: 6,
                title: "The Future of Space Exploration",
                category: "Science",
                difficulty: "advanced",
                wordCount: 110,
                text: `Space exploration is entering an unprecedented era of discovery and innovation. Private companies like SpaceX and Blue Origin are revolutionizing access to orbit, while NASA's Artemis program aims to return humans to the Moon. Beyond our lunar neighbor, Mars beckons as the next frontier for human settlement. Scientists are developing technologies for sustainable habitats, in-situ resource utilization, and protecting astronauts from cosmic radiation during long-duration missions. The challenges are immense, but so too are the potential rewards: new scientific knowledge, technological spinoffs, and perhaps one day, a multi-planetary civilization.`,
                preview: "Space exploration is entering an unprecedented era of discovery..."
            },
            {
                id: 7,
                title: "Coffee Culture Around the World",
                category: "Culture",
                difficulty: "beginner",
                wordCount: 82,
                text: `Coffee is more than just a beverage; it's a global cultural phenomenon. In Italy, espresso is a quick ritual enjoyed at the bar. Turkish coffee is thick and sweet, often used for fortune-telling. In Ethiopia, the coffee ceremony is an elaborate social event lasting hours. Japanese kiss cafes pair coffee with cat companions. Whether you prefer a simple black coffee or an elaborate latte art creation, this beloved drink connects people across cultures and continents.`,
                preview: "Coffee is more than just a beverage; it's a global cultural phenomenon..."
            },
            {
                id: 8,
                title: "The Psychology of Decision Making",
                category: "Psychology",
                difficulty: "intermediate",
                wordCount: 92,
                text: `Every day, we make thousands of decisions, from trivial choices to life-changing ones. Psychologists have discovered that our decision-making is often influenced by cognitive biases we're not aware of. Confirmation bias leads us to seek information that supports our existing beliefs. The anchoring effect causes us to rely too heavily on the first piece of information we encounter. Understanding these mental shortcuts can help us make more rational choices and avoid common pitfalls in our thinking.`,
                preview: "Every day, we make thousands of decisions..."
            }
        ];

        // Encode text for URL (same as App.tsx)
        function encodeTextForUrl(text) {
            try {
                const encoded = btoa(encodeURIComponent(text).replace(/%([0-9A-F]{2})/g,
                    (_, p1) => String.fromCharCode(parseInt(p1, 16))));
                return encoded;
            } catch {
                return '';
            }
        }

        // Get difficulty badge class
        function getDifficultyClass(difficulty) {
            switch(difficulty) {
                case 'beginner': return 'difficulty-beginner';
                case 'intermediate': return 'difficulty-intermediate';
                case 'advanced': return 'difficulty-advanced';
                default: return 'difficulty-beginner';
            }
        }

        // Get difficulty label
        function getDifficultyLabel(difficulty) {
            switch(difficulty) {
                case 'beginner': return 'Beginner';
                case 'intermediate': return 'Intermediate';
                case 'advanced': return 'Advanced';
                default: return 'Beginner';
            }
        }

        // Toggle full text visibility
        function toggleFullText(id) {
            // Handle both sample texts and history items
            const isHistory = id.startsWith('history-');
            const index = isHistory ? id.replace('history-', '') : id;
            const prefix = isHistory ? 'history' : '';
            
            const content = document.getElementById(`${prefix}${prefix ? 'FullText' : 'fullText'}-${index}`);
            const btn = document.getElementById(`${prefix}${prefix ? 'ExpandBtn' : 'expandBtn'}-${index}`);
            const label = document.getElementById(`${prefix}${prefix ? 'ExpandLabel' : 'expandLabel'}-${index}`);

            const isExpanded = content.classList.toggle('expanded');
            btn.classList.toggle('expanded', isExpanded);
            label.textContent = isExpanded ? 'Hide full text' : 'Show full text';
        }

        // Load and render history
        function loadHistory() {
            try {
                const historyStr = localStorage.getItem(STORAGE_KEY_HISTORY);
                if (!historyStr) return [];
                
                const history = JSON.parse(historyStr);
                return history || [];
            } catch (error) {
                console.error('Failed to load history:', error);
                return [];
            }
        }

        function renderHistory() {
            const history = loadHistory();
            const historySection = document.getElementById('historySection');
            const historyContainer = document.getElementById('historyCards');

            if (history.length === 0) {
                historySection.classList.add('hidden');
                return;
            }

            // Sort by timestamp descending (most recent first)
            history.sort((a, b) => b.timestamp - a.timestamp);

            historySection.classList.remove('hidden');
            historyContainer.innerHTML = '';

            history.forEach((item, index) => {
                const encodedText = encodeTextForUrl(item.text);
                const date = new Date(item.timestamp);
                const formattedDate = date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const card = document.createElement('div');
                card.className = 'text-card bg-gradient-to-br from-slate-50 to-white rounded-lg shadow-sm border border-slate-200 hover:border-sky-300 transition-all';
                card.style.animationDelay = `${index * 0.05}s`;

                const wordCount = item.text.split(/\s+/).length;

                card.innerHTML = `
                    <div class="p-4">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs font-medium text-sky-600 uppercase tracking-wide">History</span>
                                    <span class="text-xs text-slate-400">${formattedDate}</span>
                                </div>
                                <p class="text-sm text-slate-700 leading-relaxed line-clamp-3 font-serif">
                                    "${item.preview}"
                                </p>
                            </div>
                            <button onclick="deleteHistoryItem(${index})" class="ml-2 p-1 text-slate-400 hover:text-red-500 transition-colors flex-shrink-0" title="Delete">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>

                        <!-- Expandable full text -->
                        <div class="full-text-content" id="historyFullText-${index}">
                            <div class="bg-slate-50 rounded-lg p-3 mb-2 border border-slate-200">
                                <p class="text-slate-700 text-sm leading-relaxed font-serif">${item.text}</p>
                            </div>
                        </div>

                        <!-- Expand/Collapse button -->
                        <button onclick="toggleFullText('history-${index}')" class="flex items-center gap-1 text-xs text-slate-500 hover:text-slate-700 mb-2 transition-colors">
                            <svg class="w-4 h-4 expand-btn" id="historyExpandBtn-${index}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                            <span id="historyExpandLabel-${index}">Show full text</span>
                        </button>

                        <div class="flex items-center justify-between pt-2 border-t border-slate-100">
                            <span class="text-xs text-slate-400">${wordCount} words</span>
                            <a href="/?t=${encodedText}"
                               class="inline-flex items-center px-3 py-1.5 bg-sky-500 text-white text-xs font-medium rounded hover:bg-sky-600 transition-colors">
                                <svg class="w-3 h-3 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                                </svg>
                                Practice
                            </a>
                        </div>
                    </div>
                `;

                historyContainer.appendChild(card);
            });
        }

        function deleteHistoryItem(index) {
            if (!confirm('Delete this text from history?')) return;

            const history = loadHistory();
            history.splice(index, 1);
            localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(history));
            renderHistory();
        }

        function clearHistory() {
            if (!confirm('Clear all history? This cannot be undone.')) return;

            localStorage.removeItem(STORAGE_KEY_HISTORY);
            renderHistory();
        }

        // Modal control
        function openGenerateModal() {
            const modal = document.getElementById('generateModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('generatePrompt').focus();
        }

        function closeGenerateModal(event) {
            if (event && event.target.id !== 'generateModal') return;
            const modal = document.getElementById('generateModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('generateError').classList.add('hidden');
            document.getElementById('generateSuccess').classList.add('hidden');
        }

        // Generate text with AI
        async function generateText() {
            const promptInput = document.getElementById('generatePrompt');
            const lengthSelect = document.getElementById('textLength');
            const generateBtn = document.getElementById('generateBtn');
            const errorDiv = document.getElementById('generateError');
            const successDiv = document.getElementById('generateSuccess');

            const userPrompt = promptInput.value.trim();
            if (!userPrompt) {
                showError('Please enter a description of the text you want to generate.');
                return;
            }

            // Check API key
            const apiKey = localStorage.getItem(STORAGE_KEY_API);
            if (!apiKey) {
                showError('Please configure your Gemini API key in the main app first.');
                return;
            }

            // Disable button
            generateBtn.disabled = true;
            generateBtn.innerHTML = `
                <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Generating...
            `;
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');

            try {
                const lengthMap = {
                    short: '50-100 words',
                    medium: '100-200 words',
                    long: '200-300 words'
                };
                const length = lengthMap[lengthSelect.value];

                const systemPrompt = `You are an English language teacher creating practice texts for students. Generate an English text based on the user's request. The text should be:
- Engaging and interesting
- Appropriate for language learning
- ${length} in length
- Well-structured with proper grammar and punctuation
- Natural and conversational

User request: ${userPrompt}

Generate ONLY the practice text, without any additional commentary or explanation.`;

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: systemPrompt
                                }]
                            }]
                        })
                    }
                );

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }

                const data = await response.json();
                const generatedText = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!generatedText) {
                    throw new Error('No text generated from API');
                }

                // Save to history with duplicate check
                const history = loadHistory();
                const preview = generatedText.substring(0, 100) + (generatedText.length > 100 ? '...' : '');
                const existingIndex = history.findIndex(item => item.text === generatedText);
                if (existingIndex !== -1) {
                    history[existingIndex].timestamp = Date.now();
                    history[existingIndex].preview = preview;
                } else {
                    history.unshift({
                        text: generatedText,
                        timestamp: Date.now(),
                        preview
                    });
                }
                const trimmedHistory = history.slice(0, 50);
                localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(trimmedHistory));

                // Show success and redirect
                successDiv.textContent = 'Text generated successfully! Redirecting...';
                successDiv.classList.remove('hidden');

                setTimeout(() => {
                    const encodedText = encodeTextForUrl(generatedText);
                    window.location.href = `/?t=${encodedText}`;
                }, 1000);

            } catch (error) {
                console.error('Generation error:', error);
                showError(`Failed to generate text: ${error.message}`);
                
                // Re-enable button
                generateBtn.disabled = false;
                generateBtn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    Generate
                `;
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('generateError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // Render text cards
        function renderCards() {
            const container = document.getElementById('textCards');

            textSnippets.forEach((snippet, index) => {
                const encodedText = encodeTextForUrl(snippet.text);
                const card = document.createElement('div');
                card.className = 'text-card bg-white rounded-xl shadow-md border border-slate-200 animate-fade-in';
                card.style.animationDelay = `${index * 0.1}s`;

                card.innerHTML = `
                    <div class="p-6">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <span class="text-xs font-medium text-slate-500 uppercase tracking-wide">${snippet.category}</span>
                                <h3 class="text-xl font-semibold text-slate-900 mt-1">${snippet.title}</h3>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${getDifficultyClass(snippet.difficulty)}">
                                ${getDifficultyLabel(snippet.difficulty)}
                            </span>
                        </div>

                        <p class="text-slate-600 text-sm leading-relaxed mb-2 font-serif line-clamp-3 preview-text">
                            "${snippet.preview}"
                        </p>

                        <!-- Expandable full text -->
                        <div class="full-text-content" id="fullText-${snippet.id}">
                            <div class="bg-slate-50 rounded-lg p-4 mb-4 border border-slate-200">
                                <p class="text-slate-700 text-sm leading-relaxed font-serif">${snippet.text}</p>
                            </div>
                        </div>

                        <!-- Expand/Collapse button -->
                        <button onclick="toggleFullText(${snippet.id})" class="flex items-center gap-1 text-xs text-slate-500 hover:text-slate-700 mb-4 transition-colors">
                            <svg class="w-4 h-4 expand-btn" id="expandBtn-${snippet.id}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                            <span id="expandLabel-${snippet.id}">Show full text</span>
                        </button>

                        <div class="flex items-center justify-between">
                            <span class="text-xs text-slate-400">${snippet.wordCount} words</span>
                            <a href="/?t=${encodedText}"
                               class="inline-flex items-center px-4 py-2 bg-brand-500 text-white text-sm font-medium rounded-lg hover:bg-brand-600 transition-colors">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                                </svg>
                                Start Practice
                            </a>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderHistory();
            renderCards();
        });
    </script>
</body>
</html>
